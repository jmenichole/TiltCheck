#!/bin/bash

# TrapHouse Discord Server Template - Deployment Guide
# Step-by-step production deployment

echo "ğŸ  TrapHouse Discord Server Template - Deployment Guide"
echo "======================================================="

echo ""
echo "ğŸ“‹ PRE-DEPLOYMENT CHECKLIST:"
echo "============================="
echo "âœ… 1. Environment Configuration (.env.server)"
echo "âœ… 2. Docker Installation"
echo "âš ï¸  3. Docker Service Running (Start Docker Desktop)"
echo "âš ï¸  4. Discord Bot Tokens"
echo "âš ï¸  5. Domain Configuration"
echo ""

echo "ğŸš€ DEPLOYMENT STEPS:"
echo "===================="
echo ""

echo "Step 1: Start Docker Desktop"
echo "-----------------------------"
echo "ğŸ”¹ Open Docker Desktop application"
echo "ğŸ”¹ Wait for Docker to start (green light in system tray)"
echo "ğŸ”¹ Verify with: docker ps"
echo ""

echo "Step 2: Load Environment Variables"
echo "-----------------------------------"
echo "ğŸ”¹ Copy production config:"
echo "   export \$(cat .env.server | xargs)"
echo ""
echo "ğŸ”¹ Or use our server environment:"
echo "   source .env.server"
echo ""

echo "Step 3: Deploy with Docker Compose"
echo "-----------------------------------"
echo "ğŸ”¹ Build and start all services:"
echo "   docker-compose -f docker-compose.server.yml --env-file .env.server up -d"
echo ""
echo "ğŸ”¹ Check service status:"
echo "   docker-compose -f docker-compose.server.yml ps"
echo ""

echo "Step 4: Verify Deployment"
echo "-------------------------"
echo "ğŸ”¹ Run health check:"
echo "   ./health-check.sh"
echo ""
echo "ğŸ”¹ Check individual services:"
echo "   curl http://localhost:3001/health  # TrapHouse Bot"
echo "   curl http://localhost:3002/health  # JustTheTip Bot"
echo "   curl http://localhost:3003/health  # CollectClock Bot"
echo "   curl http://localhost:3004/health  # Degens Bot"
echo ""

echo "Step 5: Access Your Ecosystem"
echo "-----------------------------"
echo "ğŸ”¹ Main Site: http://localhost"
echo "ğŸ”¹ Grafana Dashboard: http://localhost:3010"
echo "ğŸ”¹ Prometheus Metrics: http://localhost:9090"
echo ""

echo "ğŸ“Š SCALING COMMANDS:"
echo "===================="
echo "ğŸ”¹ Scale TrapHouse bot: docker-compose -f docker-compose.server.yml up -d --scale traphouse-bot=3"
echo "ğŸ”¹ Scale all bots: docker-compose -f docker-compose.server.yml up -d --scale traphouse-bot=2 --scale justthetip-bot=2"
echo "ğŸ”¹ View logs: docker-compose -f docker-compose.server.yml logs -f"
echo ""

echo "ğŸ”§ TROUBLESHOOTING:"
echo "==================="
echo "ğŸ”¹ If containers fail to start:"
echo "   - Check Docker Desktop is running"
echo "   - Verify bot tokens in .env.server"
echo "   - Check port conflicts: netstat -an | grep ':3000\\|:3001\\|:3002'"
echo ""
echo "ğŸ”¹ If database fails:"
echo "   - Check DB_PASSWORD is set"
echo "   - Verify PostgreSQL port 5432 is available"
echo ""
echo "ğŸ”¹ If OAuth fails:"
echo "   - Update Discord redirect URIs"
echo "   - Check DISCORD_CLIENT_SECRET"
echo ""

echo "ğŸŒ PRODUCTION SETUP:"
echo "===================="
echo "ğŸ”¹ Domain Setup:"
echo "   - Point DNS A record to your server IP"
echo "   - Update DOMAIN in .env.server"
echo "   - Update OAUTH_REDIRECT_URI to your domain"
echo ""
echo "ğŸ”¹ SSL Certificate (Let's Encrypt):"
echo "   certbot certonly --nginx -d traphouse.dev"
echo "   # Copy certificates to nginx/ssl/"
echo ""
echo "ğŸ”¹ Discord OAuth Update:"
echo "   - Go to Discord Developer Portal"
echo "   - Update redirect URI to: https://yourdomain.com/auth/callback"
echo ""

echo "âœ… Your TrapHouse Discord server template is ready for deployment!"
echo "ğŸ‰ Run the commands above step by step for a successful deployment."
