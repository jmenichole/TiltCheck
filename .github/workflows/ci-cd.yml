name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Lint and test
  test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check for security vulnerabilities
      run: npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: Run linter (if configured)
      run: npm run lint || echo "No linter configured"
      continue-on-error: true
      
    - name: Run tests (if configured)
      run: npm test || echo "No tests configured"
      continue-on-error: true
      
    - name: Validate configuration files
      run: |
        node -e "require('./config/database.js')"
        node -e "require('./config/rate-limit.js')"
        node -e "require('./config/jwt-secret.js')"

  # Build Docker image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      if: github.event_name == 'push'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      
    - name: Build and push Docker image
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/tiltcheck:latest
          ${{ secrets.DOCKER_USERNAME }}/tiltcheck:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Deploy to production (Railway) - ONE-CLICK DEPLOYMENT
  deploy-railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Railway CLI
      run: npm install -g @railway/cli
      
    - name: Deploy to Railway
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        railway link --project ${{ secrets.RAILWAY_PROJECT_ID }}
        railway up --detach
        
    - name: Set Railway environment variables
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        railway variables set NODE_ENV=production
        railway variables set PORT=3000
        railway variables set JWT_SECRET="${{ secrets.JWT_SECRET }}"
        railway variables set COINBASE_APP_ID="${{ secrets.COINBASE_APP_ID }}"
        railway variables set COINBASE_API_KEY="${{ secrets.COINBASE_API_KEY }}"
        railway variables set COINBASE_API_SECRET="${{ secrets.COINBASE_API_SECRET }}"
        railway variables set DISCORD_CLIENT_ID="${{ secrets.DISCORD_CLIENT_ID }}"
        railway variables set DISCORD_CLIENT_SECRET="${{ secrets.DISCORD_CLIENT_SECRET }}"
        railway variables set DISCORD_ALERT_WEBHOOK="${{ secrets.DISCORD_ALERT_WEBHOOK }}"
        railway variables set CORS_ORIGIN="${{ secrets.CORS_ORIGIN }}"
        railway variables set DB_TYPE="${{ secrets.DB_TYPE }}"
        railway variables set RATE_LIMIT_ENABLED=true
        railway variables set SSL_ENABLED=true
        
    - name: Wait for deployment
      run: sleep 30
      
    - name: Health check
      run: |
        RAILWAY_URL=$(railway status --json | jq -r '.deployments[0].url')
        curl -f https://${RAILWAY_URL}/health || exit 1

  # Deploy to VPS (alternative)
  deploy-vps:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd /opt/tiltcheck
          git pull origin main
          npm install --production
          pm2 restart tiltcheck || pm2 start api-server.js --name tiltcheck
          pm2 save

  # Database migration (if needed)
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-railway
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run migrations
      env:
        DB_TYPE: ${{ secrets.DB_TYPE }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        node scripts/migrate-to-database.js || echo "Migration skipped or failed"

  # Notify on success/failure
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-vps]
    if: always()
    
    steps:
    - name: Send Discord notification
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [ "${{ needs.deploy-railway.result }}" == "success" ] || [ "${{ needs.deploy-vps.result }}" == "success" ]; then
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"✅ TiltCheck deployed successfully! Commit: ${{ github.sha }}\"}" \
               $DISCORD_WEBHOOK
        else
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"❌ TiltCheck deployment failed! Check logs.\"}" \
               $DISCORD_WEBHOOK
        fi
