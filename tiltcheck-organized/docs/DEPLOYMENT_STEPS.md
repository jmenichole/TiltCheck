#!/bin/bash

# TrapHouse Discord Server Template - Deployment Guide
# Step-by-step production deployment

echo "🏠 TrapHouse Discord Server Template - Deployment Guide"
echo "======================================================="

echo ""
echo "📋 PRE-DEPLOYMENT CHECKLIST:"
echo "============================="
echo "✅ 1. Environment Configuration (.env.server)"
echo "✅ 2. Docker Installation"
echo "⚠️  3. Docker Service Running (Start Docker Desktop)"
echo "⚠️  4. Discord Bot Tokens"
echo "⚠️  5. Domain Configuration"
echo ""

echo "🚀 DEPLOYMENT STEPS:"
echo "===================="
echo ""

echo "Step 1: Start Docker Desktop"
echo "-----------------------------"
echo "🔹 Open Docker Desktop application"
echo "🔹 Wait for Docker to start (green light in system tray)"
echo "🔹 Verify with: docker ps"
echo ""

echo "Step 2: Load Environment Variables"
echo "-----------------------------------"
echo "🔹 Copy production config:"
echo "   export \$(cat .env.server | xargs)"
echo ""
echo "🔹 Or use our server environment:"
echo "   source .env.server"
echo ""

echo "Step 3: Deploy with Docker Compose"
echo "-----------------------------------"
echo "🔹 Build and start all services:"
echo "   docker-compose -f docker-compose.server.yml --env-file .env.server up -d"
echo ""
echo "🔹 Check service status:"
echo "   docker-compose -f docker-compose.server.yml ps"
echo ""

echo "Step 4: Verify Deployment"
echo "-------------------------"
echo "🔹 Run health check:"
echo "   ./health-check.sh"
echo ""
echo "🔹 Check individual services:"
echo "   curl http://localhost:3001/health  # TrapHouse Bot"
echo "   curl http://localhost:3002/health  # JustTheTip Bot"
echo "   curl http://localhost:3003/health  # CollectClock Bot"
echo "   curl http://localhost:3004/health  # Degens Bot"
echo ""

echo "Step 5: Access Your Ecosystem"
echo "-----------------------------"
echo "🔹 Main Site: http://localhost"
echo "🔹 Grafana Dashboard: http://localhost:3010"
echo "🔹 Prometheus Metrics: http://localhost:9090"
echo ""

echo "📊 SCALING COMMANDS:"
echo "===================="
echo "🔹 Scale TrapHouse bot: docker-compose -f docker-compose.server.yml up -d --scale traphouse-bot=3"
echo "🔹 Scale all bots: docker-compose -f docker-compose.server.yml up -d --scale traphouse-bot=2 --scale justthetip-bot=2"
echo "🔹 View logs: docker-compose -f docker-compose.server.yml logs -f"
echo ""

echo "🔧 TROUBLESHOOTING:"
echo "==================="
echo "🔹 If containers fail to start:"
echo "   - Check Docker Desktop is running"
echo "   - Verify bot tokens in .env.server"
echo "   - Check port conflicts: netstat -an | grep ':3000\\|:3001\\|:3002'"
echo ""
echo "🔹 If database fails:"
echo "   - Check DB_PASSWORD is set"
echo "   - Verify PostgreSQL port 5432 is available"
echo ""
echo "🔹 If OAuth fails:"
echo "   - Update Discord redirect URIs"
echo "   - Check DISCORD_CLIENT_SECRET"
echo ""

echo "🌐 PRODUCTION SETUP:"
echo "===================="
echo "🔹 Domain Setup:"
echo "   - Point DNS A record to your server IP"
echo "   - Update DOMAIN in .env.server"
echo "   - Update OAUTH_REDIRECT_URI to your domain"
echo ""
echo "🔹 SSL Certificate (Let's Encrypt):"
echo "   certbot certonly --nginx -d traphouse.dev"
echo "   # Copy certificates to nginx/ssl/"
echo ""
echo "🔹 Discord OAuth Update:"
echo "   - Go to Discord Developer Portal"
echo "   - Update redirect URI to: https://yourdomain.com/auth/callback"
echo ""

echo "✅ Your TrapHouse Discord server template is ready for deployment!"
echo "🎉 Run the commands above step by step for a successful deployment."
