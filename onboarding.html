<!--
  Copyright (c) 2024-2025 JME (jmenichole)
  All Rights Reserved
  
  PROPRIETARY AND CONFIDENTIAL
  Unauthorized copying of this file, via any medium, is strictly prohibited.
  
  This file is part of TiltCheck/TrapHouse Discord Bot ecosystem.
  For licensing information, see LICENSE file in the root directory.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onboarding | TiltCheck</title>
    <meta name="description" content="Complete your TiltCheck profile setup with our AI-guided onboarding process.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #60A5FA;
            --secondary-cyan: #4DD0E1;
            --deep-purple: #8B5CF6;
            --intervention-teal: #4FD1C5;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --cloud-grey: #B7C3D3;
            --dark-slate: #1E293B;
            --darker-slate: #0F172A;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--darker-slate) 0%, var(--dark-slate) 50%, #334155 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .onboarding-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            font-size: 1.2rem;
            color: var(--cloud-grey);
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-text {
            color: white;
            font-weight: 600;
        }

        .progress-percentage {
            color: var(--primary-blue);
            font-size: 1.5rem;
            font-weight: 800;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--deep-purple));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(96, 165, 250, 0.2);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .step-list {
            list-style: none;
        }

        .step-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .step-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .step-item.active {
            background: linear-gradient(45deg, rgba(96, 165, 250, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(96, 165, 250, 0.4);
        }

        .step-item.completed {
            opacity: 0.6;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .step-item.completed .step-icon {
            background: var(--success-green);
        }

        .step-item.active .step-icon {
            background: var(--primary-blue);
        }

        .step-title {
            color: white;
            font-weight: 600;
        }

        .step-item.completed .step-title {
            color: var(--cloud-grey);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem;
            border: 1px solid rgba(96, 165, 250, 0.2);
            min-height: 600px;
        }

        .ai-assistant {
            background: linear-gradient(45deg, rgba(96, 165, 250, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-blue), var(--deep-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .ai-name {
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .ai-role {
            color: var(--cloud-grey);
            font-size: 0.9rem;
        }

        .ai-message {
            color: white;
            line-height: 1.6;
            font-size: 1.05rem;
        }

        .step-content-title {
            font-size: 2rem;
            font-weight: 800;
            color: white;
            margin-bottom: 1rem;
        }

        .step-content-description {
            color: var(--cloud-grey);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: white;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 1rem;
        }

        .avatar-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-blue), var(--deep-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: var(--success-green);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .interest-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .interest-tag {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            color: var(--primary-blue);
            padding: 0.75rem 1.25rem;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .interest-tag:hover {
            background: rgba(96, 165, 250, 0.2);
            transform: translateY(-2px);
        }

        .interest-tag.selected {
            background: var(--primary-blue);
            color: white;
        }

        .permission-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .permission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .permission-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            font-weight: 600;
        }

        .permission-icon {
            font-size: 1.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 26px;
            transition: 0.4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: 0.4s;
        }

        input:checked + .toggle-slider {
            background-color: var(--success-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .permission-description {
            color: var(--cloud-grey);
            font-size: 0.9rem;
        }

        .connect-card {
            background: linear-gradient(45deg, rgba(96, 165, 250, 0.1), rgba(77, 208, 225, 0.1));
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .connect-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .connect-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .connect-description {
            color: var(--cloud-grey);
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-blue), var(--deep-purple));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(96, 165, 250, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-discord {
            background: #5865F2;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .completion-celebration {
            text-align: center;
            padding: 3rem 2rem;
        }

        .celebration-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
        }

        .celebration-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 1rem;
        }

        .celebration-message {
            color: var(--cloud-grey);
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 968px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .main-content {
                padding: 2rem;
            }
            
            .avatar-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="onboarding-wrapper">
        <div class="header">
            <div class="logo">üéØ</div>
            <h1 class="header-title">Welcome to TiltCheck</h1>
            <p class="header-subtitle">Let's set up your profile together</p>
        </div>

        <div class="progress-container">
            <div class="progress-info">
                <span class="progress-text">Profile Completion</span>
                <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <div class="content-grid">
            <aside class="sidebar">
                <ul class="step-list" id="stepList">
                    <!-- Steps will be populated by JavaScript -->
                </ul>
            </aside>

            <main class="main-content">
                <div class="ai-assistant" id="aiAssistant">
                    <div class="ai-header">
                        <div class="ai-avatar">ü§ñ</div>
                        <div>
                            <div class="ai-name">TiltCheck Assistant</div>
                            <div class="ai-role">Your onboarding guide</div>
                        </div>
                    </div>
                    <div class="ai-message" id="aiMessage">
                        Loading your personalized guidance...
                    </div>
                </div>

                <div id="stepContent">
                    <!-- Step content will be loaded here -->
                </div>

                <div class="action-buttons" id="actionButtons">
                    <button class="btn btn-secondary" id="skipBtn" style="display: none;">Skip for Now</button>
                    <button class="btn btn-primary" id="nextBtn">Next Step ‚Üí</button>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentStepId = 'welcome';
        let allSteps = [];
        let completedSteps = [];
        let userData = {};

        // Check authentication
        const token = localStorage.getItem('tiltcheck_token');
        if (!token) {
            window.location.href = '/login';
        }

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (data.success) {
                    userData = data.data.user;
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
            }
        }

        // Load onboarding steps
        async function loadSteps() {
            try {
                const response = await fetch(`${API_BASE}/api/onboarding/steps`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    allSteps = data.data.steps;
                    completedSteps = data.data.completedSteps;
                    currentStepId = data.data.currentStep;
                    
                    updateProgress(data.data.progress.percentage);
                    renderStepList();
                    await loadCurrentStep();
                }
            } catch (error) {
                console.error('Failed to load steps:', error);
            }
        }

        // Update progress bar
        function updateProgress(percentage) {
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }

        // Render step list
        function renderStepList() {
            const stepList = document.getElementById('stepList');
            stepList.innerHTML = '';
            
            allSteps.forEach(step => {
                const isCompleted = completedSteps.includes(step.id);
                const isActive = step.id === currentStepId;
                
                const li = document.createElement('li');
                li.className = `step-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
                li.onclick = () => navigateToStep(step.id);
                
                li.innerHTML = `
                    <div class="step-icon">${isCompleted ? '‚úì' : step.order}</div>
                    <div class="step-title">${step.title}</div>
                `;
                
                stepList.appendChild(li);
            });
        }

        // Navigate to a specific step
        function navigateToStep(stepId) {
            currentStepId = stepId;
            renderStepList();
            loadCurrentStep();
        }

        // Load AI guidance
        async function loadAIGuidance(stepId) {
            try {
                const response = await fetch(`${API_BASE}/api/onboarding/guidance?step=${stepId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('aiMessage').textContent = data.data.message;
                }
            } catch (error) {
                console.error('Failed to load AI guidance:', error);
            }
        }

        // Load current step content
        async function loadCurrentStep() {
            const step = allSteps.find(s => s.id === currentStepId);
            if (!step) return;
            
            await loadAIGuidance(currentStepId);
            
            const content = document.getElementById('stepContent');
            const skipBtn = document.getElementById('skipBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            // Show/hide skip button
            skipBtn.style.display = step.required ? 'none' : 'inline-block';
            
            // Render step-specific content
            switch (currentStepId) {
                case 'welcome':
                    content.innerHTML = renderWelcomeStep();
                    break;
                case 'basic_info':
                    content.innerHTML = renderBasicInfoStep();
                    break;
                case 'interests':
                    content.innerHTML = renderInterestsStep();
                    break;
                case 'permissions':
                    content.innerHTML = renderPermissionsStep();
                    break;
                case 'discord':
                    content.innerHTML = renderDiscordStep();
                    break;
                case 'wallet':
                    content.innerHTML = renderWalletStep();
                    break;
                case 'nft':
                    content.innerHTML = renderNFTStep();
                    break;
                case 'complete':
                    content.innerHTML = renderCompleteStep();
                    nextBtn.style.display = 'none';
                    break;
            }
            
            // Setup event listeners for interactive elements
            setupStepInteractions();
        }

        // Render welcome step
        function renderWelcomeStep() {
            return `
                <h2 class="step-content-title">üëã Welcome, ${userData.displayName || 'Friend'}!</h2>
                <p class="step-content-description">
                    We're thrilled to have you join the TiltCheck community. This quick setup will help us 
                    personalize your experience and unlock all the features you need for responsible gaming.
                </p>
                <div class="connect-card">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
                    <h3 style="color: white; margin-bottom: 1rem;">What to Expect</h3>
                    <ul style="text-align: left; color: var(--cloud-grey); max-width: 500px; margin: 0 auto;">
                        <li style="margin-bottom: 0.5rem;">‚ú® Personalized profile setup</li>
                        <li style="margin-bottom: 0.5rem;">üîó Connect Discord & wallet (optional)</li>
                        <li style="margin-bottom: 0.5rem;">üõ°Ô∏è NFT verification badge (optional)</li>
                        <li style="margin-bottom: 0.5rem;">üéÆ Join our amazing community</li>
                    </ul>
                </div>
            `;
        }

        // Render basic info step
        function renderBasicInfoStep() {
            return `
                <h2 class="step-content-title">üìù Basic Information</h2>
                <p class="step-content-description">Tell us about yourself so we can personalize your experience</p>
                
                <div class="form-section">
                    <div class="form-group">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-input" id="displayName" value="${userData.displayName || ''}" 
                               placeholder="How should others know you?">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Bio (Optional)</label>
                        <textarea class="form-input form-textarea" id="bio" 
                                  placeholder="Tell the community about yourself...">${userData.bio || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Choose Your Avatar</label>
                        <div class="avatar-grid">
                            ${['üéÆ', 'üõ°Ô∏è', 'üéØ', '‚ö°', 'üî•', 'üíé', 'üöÄ', 'üåü', 'üé®', 'üé≠', 'ü¶Ñ', 'üêâ'].map(emoji => `
                                <div class="avatar-option ${userData.avatar === emoji ? 'selected' : ''}" 
                                     data-avatar="${emoji}" onclick="selectAvatar('${emoji}')">${emoji}</div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render interests step
        function renderInterestsStep() {
            const interests = ['Responsible Gaming', 'Behavioral Analysis', 'Fairness Verification', 
                             'Community Building', 'Technical Discussion', 'Transparency', 'Feature Requests', 
                             'Sound Design', 'NFT Verification', 'Platform Integration', 'Crypto Tips', 
                             'Discord Bots'];
            
            return `
                <h2 class="step-content-title">üéØ Your Interests</h2>
                <p class="step-content-description">Help us tailor your community experience</p>
                
                <div class="form-section">
                    <div class="section-title">What interests you most?</div>
                    <div class="interest-tags">
                        ${interests.map(interest => `
                            <div class="interest-tag ${(userData.interests || []).includes(interest) ? 'selected' : ''}" 
                                 onclick="toggleInterest('${interest}')">${interest}</div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="form-section" style="margin-top: 2rem;">
                    <div class="section-title">Gaming Experience Level</div>
                    <select class="form-input" id="experienceLevel">
                        <option value="">Select your experience level</option>
                        <option value="beginner" ${userData.experienceLevel === 'beginner' ? 'selected' : ''}>New to Gaming</option>
                        <option value="casual" ${userData.experienceLevel === 'casual' ? 'selected' : ''}>Casual Gamer</option>
                        <option value="experienced" ${userData.experienceLevel === 'experienced' ? 'selected' : ''}>Experienced Player</option>
                        <option value="professional" ${userData.experienceLevel === 'professional' ? 'selected' : ''}>Professional/Industry</option>
                    </select>
                </div>
            `;
        }

        // Render permissions step
        function renderPermissionsStep() {
            const permissions = [
                { key: 'notifications', icon: 'üîî', title: 'Notifications', desc: 'Receive alerts for important events' },
                { key: 'storage', icon: 'üíæ', title: 'Local Storage', desc: 'Save your preferences locally' },
                { key: 'location', icon: 'üìç', title: 'Location', desc: 'Optional: For regional features' }
            ];
            
            return `
                <h2 class="step-content-title">üîê App Permissions</h2>
                <p class="step-content-description">Enable features for the best experience (all optional)</p>
                
                <div class="form-section">
                    ${permissions.map(perm => `
                        <div class="permission-card">
                            <div class="permission-header">
                                <div class="permission-title">
                                    <span class="permission-icon">${perm.icon}</span>
                                    ${perm.title}
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="perm_${perm.key}" 
                                           ${(userData.permissions && userData.permissions[perm.key]) ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="permission-description">${perm.desc}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render Discord step
        function renderDiscordStep() {
            const isConnected = userData.connectedAccounts && userData.connectedAccounts.discord;
            
            return `
                <h2 class="step-content-title">üí¨ Connect Discord</h2>
                <p class="step-content-description">Join our community and unlock social features</p>
                
                <div class="connect-card">
                    <div class="connect-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" style="color: #5865F2;">
                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                        </svg>
                    </div>
                    <h3 class="connect-title">${isConnected ? '‚úÖ Discord Connected' : 'Connect Discord'}</h3>
                    <p class="connect-description">
                        ${isConnected 
                            ? `Connected as ${userData.connectedAccounts.discord.username}` 
                            : 'Link your Discord account for community alerts and bot features'}
                    </p>
                    ${!isConnected ? `
                        <button class="btn btn-discord" onclick="connectDiscord()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                            </svg>
                            Connect Discord Account
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // Render wallet step
        function renderWalletStep() {
            const isConnected = userData.connectedAccounts && userData.connectedAccounts.wallet;
            
            return `
                <h2 class="step-content-title">üí∞ Connect Wallet</h2>
                <p class="step-content-description">Link your Solana wallet for tips, rewards, and NFT features</p>
                
                <div class="connect-card">
                    <div class="connect-icon">üëõ</div>
                    <h3 class="connect-title">${isConnected ? '‚úÖ Wallet Connected' : 'Connect Solana Wallet'}</h3>
                    <p class="connect-description">
                        ${isConnected 
                            ? `Connected: ${userData.connectedAccounts.wallet.address.substring(0, 8)}...${userData.connectedAccounts.wallet.address.substring(userData.connectedAccounts.wallet.address.length - 6)}` 
                            : 'Use Phantom or any Solana-compatible wallet'}
                    </p>
                    ${!isConnected ? `
                        <button class="btn btn-primary" onclick="connectWallet()">
                            Connect Phantom Wallet
                        </button>
                        <p style="margin-top: 1rem; color: var(--cloud-grey); font-size: 0.9rem;">
                            Don't have Phantom? <a href="https://phantom.app/" target="_blank" 
                            style="color: var(--primary-blue);">Download here</a>
                        </p>
                    ` : ''}
                </div>
            `;
        }

        // Render NFT step
        function renderNFTStep() {
            return `
                <h2 class="step-content-title">üõ°Ô∏è NFT Verification</h2>
                <p class="step-content-description">Get verified with a DegenTrust NFT badge</p>
                
                <div class="connect-card">
                    <div class="connect-icon">üé®</div>
                    <h3 class="connect-title">DegenTrust Verification NFT</h3>
                    <p class="connect-description">
                        Mint a verification NFT to:
                        <ul style="text-align: left; max-width: 400px; margin: 1rem auto; color: var(--cloud-grey);">
                            <li style="margin-bottom: 0.5rem;">‚úì Build community trust</li>
                            <li style="margin-bottom: 0.5rem;">‚úì Unlock premium features</li>
                            <li style="margin-bottom: 0.5rem;">‚úì Show your verified status</li>
                            <li style="margin-bottom: 0.5rem;">‚úì Get exclusive access</li>
                        </ul>
                    </p>
                    ${userData.nftMinted ? `
                        <div style="background: rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 10px; color: var(--success-green);">
                            ‚úì NFT Already Minted!
                        </div>
                    ` : `
                        <button class="btn btn-success" onclick="mintNFT()">
                            Mint Verification NFT
                        </button>
                        <p style="margin-top: 1rem; color: var(--cloud-grey); font-size: 0.9rem;">
                            Free for early adopters ‚Ä¢ Requires connected wallet
                        </p>
                    `}
                </div>
            `;
        }

        // Render complete step
        function renderCompleteStep() {
            return `
                <div class="completion-celebration">
                    <div class="celebration-icon">üéâ</div>
                    <h2 class="celebration-title">You're All Set!</h2>
                    <p class="celebration-message">
                        Welcome to the TiltCheck community! Your profile is ready, and you have access 
                        to all features. Let's start your journey towards better gaming habits.
                    </p>
                    <button class="btn btn-primary" onclick="completeOnboarding()" style="font-size: 1.2rem; padding: 1.25rem 2.5rem;">
                        Go to Dashboard üöÄ
                    </button>
                </div>
            `;
        }

        // Setup step interactions
        function setupStepInteractions() {
            // Any additional setup for interactive elements
        }

        // Avatar selection
        let selectedAvatar = userData.avatar || '';
        function selectAvatar(emoji) {
            selectedAvatar = emoji;
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.avatar === emoji) {
                    opt.classList.add('selected');
                }
            });
        }

        // Interest selection
        let selectedInterests = userData.interests || [];
        function toggleInterest(interest) {
            const index = selectedInterests.indexOf(interest);
            if (index > -1) {
                selectedInterests.splice(index, 1);
            } else {
                selectedInterests.push(interest);
            }
            
            // Update UI
            document.querySelectorAll('.interest-tag').forEach(tag => {
                if (tag.textContent === interest) {
                    tag.classList.toggle('selected');
                }
            });
        }

        // Connect Discord
        function connectDiscord() {
            // Store return URL
            localStorage.setItem('oauth_return', window.location.href);
            window.location.href = `${API_BASE}/auth/discord`;
        }

        // Connect wallet
        async function connectWallet() {
            if (typeof window.solana === 'undefined') {
                alert('Phantom wallet not detected. Please install Phantom to continue.');
                window.open('https://phantom.app/', '_blank');
                return;
            }
            
            try {
                const resp = await window.solana.connect();
                const walletAddress = resp.publicKey.toString();
                
                // Save wallet connection
                const response = await fetch(`${API_BASE}/api/profile/connect/wallet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        walletAddress,
                        walletType: 'phantom'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Wallet connected successfully!');
                    await loadUserData();
                    await loadCurrentStep();
                } else {
                    alert('Failed to connect wallet: ' + data.error);
                }
            } catch (error) {
                console.error('Wallet connection error:', error);
                alert('Failed to connect wallet. Please try again.');
            }
        }

        // Mint NFT
        function mintNFT() {
            if (!userData.connectedAccounts || !userData.connectedAccounts.wallet) {
                alert('Please connect your wallet first!');
                return;
            }
            
            // Redirect to NFT minting page
            window.location.href = '/degentrust-score.html?source=onboarding';
        }

        // Save profile data
        async function saveProfileData() {
            const updates = {};
            
            // Get data based on current step
            switch (currentStepId) {
                case 'basic_info':
                    updates.displayName = document.getElementById('displayName')?.value;
                    updates.bio = document.getElementById('bio')?.value;
                    updates.avatar = selectedAvatar;
                    break;
                case 'interests':
                    updates.interests = selectedInterests;
                    updates.experienceLevel = document.getElementById('experienceLevel')?.value;
                    break;
                case 'permissions':
                    updates.permissions = {
                        notifications: document.getElementById('perm_notifications')?.checked,
                        storage: document.getElementById('perm_storage')?.checked,
                        location: document.getElementById('perm_location')?.checked
                    };
                    
                    // Save permissions separately
                    await fetch(`${API_BASE}/api/profile/permissions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ permissions: updates.permissions })
                    });
                    break;
            }
            
            // Update profile if there are changes
            if (Object.keys(updates).length > 0) {
                await fetch(`${API_BASE}/api/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updates)
                });
            }
        }

        // Handle next button
        document.getElementById('nextBtn').addEventListener('click', async () => {
            // Save current step data
            await saveProfileData();
            
            // Move to next step
            const currentIndex = allSteps.findIndex(s => s.id === currentStepId);
            if (currentIndex < allSteps.length - 1) {
                currentStepId = allSteps[currentIndex + 1].id;
                await loadUserData();
                await loadSteps();
            }
        });

        // Handle skip button
        document.getElementById('skipBtn').addEventListener('click', async () => {
            // Move to next step without saving
            const currentIndex = allSteps.findIndex(s => s.id === currentStepId);
            if (currentIndex < allSteps.length - 1) {
                currentStepId = allSteps[currentIndex + 1].id;
                await loadSteps();
            }
        });

        // Complete onboarding
        async function completeOnboarding() {
            try {
                await fetch(`${API_BASE}/api/profile/onboarding/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                window.location.href = '/';
            } catch (error) {
                console.error('Failed to complete onboarding:', error);
            }
        }

        // Initialize
        async function init() {
            await loadUserData();
            await loadSteps();
        }

        init();
    </script>
</body>
</html>
